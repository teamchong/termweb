<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>termweb-notebook</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #1e1e1e;
      color: #cccccc;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
    }
    #header {
      height: 36px;
      background: #252526;
      display: flex;
      align-items: center;
      padding: 0 16px;
      border-bottom: 1px solid #3c3c3c;
    }
    #header h1 { font-size: 14px; font-weight: 500; flex: 1; }
    #header .status { font-size: 12px; color: #888; }

    #toolbar {
      height: 36px;
      background: #2d2d2d;
      display: flex;
      align-items: center;
      padding: 0 16px;
      gap: 8px;
      border-bottom: 1px solid #3c3c3c;
    }
    #toolbar button {
      background: #0e639c;
      color: white;
      border: none;
      padding: 4px 12px;
      font-size: 12px;
      border-radius: 3px;
      cursor: pointer;
    }
    #toolbar button:hover { background: #1177bb; }
    #toolbar button:disabled { background: #3c3c3c; color: #888; }
    #toolbar .separator { width: 1px; height: 20px; background: #3c3c3c; }

    #notebook {
      padding: 20px;
      max-width: 1000px;
      margin: 0 auto;
      height: calc(100vh - 96px);
      overflow-y: auto;
    }

    .cell {
      margin-bottom: 16px;
      border: 1px solid #3c3c3c;
      border-radius: 4px;
      background: #252526;
    }
    .cell.selected { border-color: #569cd6; }
    .cell.running { border-color: #dcdcaa; }

    .cell-toolbar {
      display: flex;
      align-items: center;
      padding: 4px 8px;
      background: #1e1e1e;
      border-bottom: 1px solid #3c3c3c;
      font-size: 11px;
    }
    .cell-toolbar .type { color: #569cd6; font-weight: 500; }
    .cell-toolbar .actions { margin-left: auto; }
    .cell-toolbar button {
      background: none;
      border: none;
      color: #888;
      cursor: pointer;
      padding: 2px 6px;
    }
    .cell-toolbar button:hover { color: #cccccc; }

    .cell-input {
      padding: 8px 12px;
      font-family: 'Fira Code', Consolas, monospace;
      font-size: 13px;
      line-height: 1.5;
    }
    .cell-input textarea {
      width: 100%;
      background: transparent;
      border: none;
      color: #d4d4d4;
      font-family: inherit;
      font-size: inherit;
      line-height: inherit;
      resize: none;
      outline: none;
    }

    .cell-output {
      border-top: 1px solid #3c3c3c;
      padding: 8px 12px;
      background: #1e1e1e;
      font-family: 'Fira Code', Consolas, monospace;
      font-size: 13px;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .cell-output.error { color: #f14c4c; }
    .cell-output.stream { color: #6a9955; }
    .cell-output:empty { display: none; }

    .cell.markdown .cell-input { display: none; }
    .cell.markdown .cell-rendered {
      padding: 12px;
      line-height: 1.6;
    }
    .cell.markdown.editing .cell-input { display: block; }
    .cell.markdown.editing .cell-rendered { display: none; }

    .cell-rendered h1, .cell-rendered h2, .cell-rendered h3 { color: #569cd6; margin: 16px 0 8px; }
    .cell-rendered p { margin-bottom: 12px; }
    .cell-rendered code { background: #2d2d2d; padding: 2px 6px; border-radius: 4px; }
    .cell-rendered pre { background: #2d2d2d; padding: 12px; border-radius: 4px; overflow-x: auto; }

    #shortcuts {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 24px;
      background: #007acc;
      display: flex;
      align-items: center;
      padding: 0 12px;
      font-size: 11px;
      color: white;
    }
    #shortcuts span { margin-right: 16px; }
    #shortcuts kbd { background: rgba(255,255,255,0.2); padding: 1px 5px; border-radius: 2px; margin-right: 4px; }

    .execution-count {
      color: #569cd6;
      font-size: 11px;
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <div id="header">
    <h1 id="filename">New Notebook</h1>
    <span class="status" id="status">Ready</span>
  </div>
  <div id="toolbar">
    <button id="btn-run">Run Cell</button>
    <button id="btn-run-all">Run All</button>
    <div class="separator"></div>
    <button id="btn-add-code">+ Code</button>
    <button id="btn-add-md">+ Markdown</button>
    <div class="separator"></div>
    <button id="btn-save">Save</button>
  </div>
  <div id="notebook"></div>
  <div id="shortcuts">
    <span><kbd>Shift+Enter</kbd> Run cell</span>
    <span><kbd>Ctrl+Enter</kbd> Run & stay</span>
    <span><kbd>Ctrl+S</kbd> Save</span>
    <span><kbd>Ctrl+Q</kbd> Quit</span>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    let notebook = { cells: [] };
    let notebookPath = null;
    let pythonAvailable = false;
    let selectedCell = null;
    let executionCount = 0;

    // WebSocket connection
    const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
    const ws = new WebSocket(`${protocol}//${location.host}`);

    ws.onmessage = (event) => {
      const msg = JSON.parse(event.data);

      if (msg.type === 'result' || msg.type === 'error') {
        const cell = document.querySelector(`[data-cell-id="${msg.cellId}"]`);
        if (cell) {
          cell.classList.remove('running');
          const output = cell.querySelector('.cell-output');
          if (msg.error) {
            output.className = 'cell-output error';
            output.textContent = msg.error;
          } else {
            output.className = 'cell-output stream';
            output.textContent = msg.output || '';
          }

          // Update notebook data
          const idx = parseInt(msg.cellId.replace('cell-', ''));
          if (notebook.cells[idx]) {
            notebook.cells[idx].outputs = [{
              output_type: msg.error ? 'error' : 'stream',
              text: msg.error || msg.output
            }];
          }
        }
      } else if (msg.type === 'status') {
        const cell = document.querySelector(`[data-cell-id="${msg.cellId}"]`);
        if (cell) {
          cell.classList.add('running');
        }
        document.getElementById('status').textContent = 'Running...';
      } else if (msg.type === 'saved') {
        document.getElementById('status').textContent = 'Saved';
        setTimeout(() => {
          document.getElementById('status').textContent = 'Ready';
        }, 2000);
      }
    };

    // Load notebook
    async function init() {
      try {
        const res = await fetch('/notebook.json');
        const data = await res.json();
        notebook = data.notebook;
        notebookPath = data.path;
        pythonAvailable = data.pythonAvailable;

        if (notebookPath) {
          document.getElementById('filename').textContent = notebookPath.split('/').pop();
        }

        if (!pythonAvailable) {
          document.getElementById('status').textContent = 'Python not found';
        }

        renderNotebook();
      } catch (err) {
        console.error('Error loading notebook:', err);
      }
    }

    function renderNotebook() {
      const container = document.getElementById('notebook');
      container.innerHTML = '';

      if (!notebook.cells || notebook.cells.length === 0) {
        notebook.cells = [{
          cell_type: 'code',
          source: ['# Start writing Python code here\n'],
          outputs: [],
          execution_count: null
        }];
      }

      notebook.cells.forEach((cell, idx) => {
        const cellEl = createCellElement(cell, idx);
        container.appendChild(cellEl);
      });
    }

    function createCellElement(cell, idx) {
      const div = document.createElement('div');
      div.className = `cell ${cell.cell_type}`;
      div.dataset.cellId = `cell-${idx}`;

      const source = Array.isArray(cell.source) ? cell.source.join('') : cell.source || '';
      const outputs = cell.outputs || [];

      div.innerHTML = `
        <div class="cell-toolbar">
          <span class="type">${cell.cell_type === 'code' ? 'Python' : 'Markdown'}</span>
          ${cell.execution_count ? `<span class="execution-count">[${cell.execution_count}]</span>` : ''}
          <div class="actions">
            <button onclick="runCell(${idx})">Run</button>
            <button onclick="deleteCell(${idx})">Delete</button>
          </div>
        </div>
        <div class="cell-input">
          <textarea rows="${Math.max(3, source.split('\n').length)}" oninput="updateCell(${idx}, this.value)">${escapeHtml(source)}</textarea>
        </div>
        ${cell.cell_type === 'markdown' ? `<div class="cell-rendered">${marked.parse(source)}</div>` : ''}
        <div class="cell-output ${outputs[0]?.output_type === 'error' ? 'error' : 'stream'}">${formatOutput(outputs)}</div>
      `;

      div.onclick = (e) => {
        if (!e.target.matches('button, textarea')) {
          selectCell(div);
        }
      };

      return div;
    }

    function escapeHtml(str) {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function formatOutput(outputs) {
      if (!outputs || outputs.length === 0) return '';
      return outputs.map(o => {
        if (o.text) return Array.isArray(o.text) ? o.text.join('') : o.text;
        if (o.data && o.data['text/plain']) return o.data['text/plain'].join('');
        return '';
      }).join('\n');
    }

    function selectCell(cellEl) {
      document.querySelectorAll('.cell.selected').forEach(c => c.classList.remove('selected'));
      cellEl.classList.add('selected');
      selectedCell = cellEl;
    }

    function updateCell(idx, value) {
      notebook.cells[idx].source = value.split('\n').map((l, i, arr) => i < arr.length - 1 ? l + '\n' : l);
    }

    function runCell(idx) {
      const cell = notebook.cells[idx];
      if (cell.cell_type !== 'code') return;

      executionCount++;
      cell.execution_count = executionCount;

      const source = Array.isArray(cell.source) ? cell.source.join('') : cell.source;

      ws.send(JSON.stringify({
        type: 'execute',
        cellId: `cell-${idx}`,
        code: source
      }));

      // Update execution count display
      const cellEl = document.querySelector(`[data-cell-id="cell-${idx}"]`);
      const countEl = cellEl.querySelector('.execution-count');
      if (countEl) {
        countEl.textContent = `[${executionCount}]`;
      } else {
        cellEl.querySelector('.cell-toolbar .type').insertAdjacentHTML('afterend',
          `<span class="execution-count">[${executionCount}]</span>`);
      }
    }

    function deleteCell(idx) {
      if (notebook.cells.length <= 1) return;
      notebook.cells.splice(idx, 1);
      renderNotebook();
    }

    function addCell(type) {
      notebook.cells.push({
        cell_type: type,
        source: type === 'code' ? [''] : ['# New markdown cell\n'],
        outputs: [],
        execution_count: null
      });
      renderNotebook();
    }

    function saveNotebook() {
      ws.send(JSON.stringify({
        type: 'save',
        notebook: notebook
      }));
    }

    function runAllCells() {
      notebook.cells.forEach((cell, idx) => {
        if (cell.cell_type === 'code') {
          runCell(idx);
        }
      });
    }

    // Event listeners
    document.getElementById('btn-run').onclick = () => {
      if (selectedCell) {
        const idx = parseInt(selectedCell.dataset.cellId.replace('cell-', ''));
        runCell(idx);
      }
    };
    document.getElementById('btn-run-all').onclick = runAllCells;
    document.getElementById('btn-add-code').onclick = () => addCell('code');
    document.getElementById('btn-add-md').onclick = () => addCell('markdown');
    document.getElementById('btn-save').onclick = saveNotebook;

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        saveNotebook();
      } else if (e.shiftKey && e.key === 'Enter') {
        e.preventDefault();
        if (selectedCell) {
          const idx = parseInt(selectedCell.dataset.cellId.replace('cell-', ''));
          runCell(idx);
        }
      }
    });

    init();
  </script>
</body>
</html>
