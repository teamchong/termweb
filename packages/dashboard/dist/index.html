<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>termweb-dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #1e1e1e;
      color: #cccccc;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 13px;
    }
    #header {
      height: 36px;
      background: #252526;
      display: flex;
      align-items: center;
      padding: 0 16px;
      border-bottom: 1px solid #3c3c3c;
    }
    #header h1 { font-size: 14px; font-weight: 600; flex: 1; }
    #header .info { font-size: 11px; color: #888; }

    #dashboard {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      padding: 16px;
      height: calc(100vh - 36px);
      overflow: auto;
    }
    .card {
      background: #252526;
      border: 1px solid #3c3c3c;
      border-radius: 6px;
      padding: 16px;
    }
    .card h2 {
      font-size: 12px;
      font-weight: 600;
      color: #569cd6;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .card.full-width { grid-column: span 2; }

    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid #3c3c3c;
    }
    .stat-row:last-child { border-bottom: none; }
    .stat-label { color: #888; }
    .stat-value { font-weight: 500; }
    .stat-value.high { color: #f14c4c; }
    .stat-value.medium { color: #dcdcaa; }
    .stat-value.low { color: #6a9955; }

    .progress-bar {
      height: 8px;
      background: #3c3c3c;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 6px;
    }
    .progress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    .progress-fill.cpu { background: linear-gradient(90deg, #4ec9b0, #569cd6); }
    .progress-fill.mem { background: linear-gradient(90deg, #569cd6, #9cdcfe); }
    .progress-fill.disk { background: linear-gradient(90deg, #dcdcaa, #ce9178); }

    .chart-container { height: 150px; position: relative; }

    #process-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    #process-table th {
      text-align: left;
      padding: 6px 8px;
      background: #1e1e1e;
      color: #569cd6;
      font-weight: 600;
    }
    #process-table td {
      padding: 4px 8px;
      border-bottom: 1px solid #2d2d2d;
    }
    #process-table tr:hover { background: #2a2d2e; }

    .core-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    .core-item {
      text-align: center;
      padding: 8px;
      background: #1e1e1e;
      border-radius: 4px;
    }
    .core-item .label { font-size: 10px; color: #888; }
    .core-item .value { font-size: 16px; font-weight: 600; }
  </style>
</head>
<body>
  <div id="header">
    <h1>System Dashboard</h1>
    <span class="info" id="system-info">Loading...</span>
  </div>

  <div id="dashboard">
    <!-- CPU Card -->
    <div class="card">
      <h2>CPU</h2>
      <div id="cpu-info"></div>
      <div class="chart-container">
        <canvas id="cpu-chart"></canvas>
      </div>
      <div class="progress-bar">
        <div class="progress-fill cpu" id="cpu-bar" style="width: 0%"></div>
      </div>
      <div id="cpu-cores" class="core-grid" style="margin-top: 12px;"></div>
    </div>

    <!-- Memory Card -->
    <div class="card">
      <h2>Memory</h2>
      <div id="mem-info"></div>
      <div class="chart-container">
        <canvas id="mem-chart"></canvas>
      </div>
      <div class="progress-bar">
        <div class="progress-fill mem" id="mem-bar" style="width: 0%"></div>
      </div>
    </div>

    <!-- Network Card -->
    <div class="card">
      <h2>Network</h2>
      <div class="chart-container">
        <canvas id="net-chart"></canvas>
      </div>
      <div id="net-info"></div>
    </div>

    <!-- Disk Card -->
    <div class="card">
      <h2>Disk</h2>
      <div id="disk-info"></div>
    </div>

    <!-- Processes Card -->
    <div class="card full-width">
      <h2>Top Processes</h2>
      <table id="process-table">
        <thead>
          <tr>
            <th>PID</th>
            <th>Name</th>
            <th>CPU %</th>
            <th>MEM %</th>
            <th>State</th>
            <th>User</th>
          </tr>
        </thead>
        <tbody id="process-tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const MAX_DATA_POINTS = 60;
    const cpuData = [];
    const memData = [];
    const netRxData = [];
    const netTxData = [];
    const labels = [];

    // Initialize charts
    const chartOptions = {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 0 },
      scales: {
        x: { display: false },
        y: {
          min: 0,
          max: 100,
          ticks: { color: '#888', font: { size: 10 } },
          grid: { color: '#3c3c3c' }
        }
      },
      plugins: { legend: { display: false } }
    };

    const cpuChart = new Chart(document.getElementById('cpu-chart'), {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          data: cpuData,
          borderColor: '#569cd6',
          backgroundColor: 'rgba(86, 156, 214, 0.1)',
          fill: true,
          tension: 0.3,
          pointRadius: 0
        }]
      },
      options: chartOptions
    });

    const memChart = new Chart(document.getElementById('mem-chart'), {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          data: memData,
          borderColor: '#4ec9b0',
          backgroundColor: 'rgba(78, 201, 176, 0.1)',
          fill: true,
          tension: 0.3,
          pointRadius: 0
        }]
      },
      options: chartOptions
    });

    const netChart = new Chart(document.getElementById('net-chart'), {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'RX',
          data: netRxData,
          borderColor: '#6a9955',
          tension: 0.3,
          pointRadius: 0
        }, {
          label: 'TX',
          data: netTxData,
          borderColor: '#ce9178',
          tension: 0.3,
          pointRadius: 0
        }]
      },
      options: {
        ...chartOptions,
        scales: {
          ...chartOptions.scales,
          y: { ...chartOptions.scales.y, max: undefined }
        },
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: { color: '#888', font: { size: 10 }, boxWidth: 12 }
          }
        }
      }
    });

    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function formatBps(bytes) {
      return formatBytes(bytes) + '/s';
    }

    function getLoadClass(load) {
      if (load > 80) return 'high';
      if (load > 50) return 'medium';
      return 'low';
    }

    function updateUI(data, isFull) {
      const now = new Date().toLocaleTimeString();
      labels.push(now);
      if (labels.length > MAX_DATA_POINTS) labels.shift();

      // CPU
      cpuData.push(data.cpu.load);
      if (cpuData.length > MAX_DATA_POINTS) cpuData.shift();
      cpuChart.update('none');
      document.getElementById('cpu-bar').style.width = data.cpu.load.toFixed(1) + '%';

      if (isFull && data.cpu.brand) {
        document.getElementById('cpu-info').innerHTML = `
          <div class="stat-row">
            <span class="stat-label">Model</span>
            <span class="stat-value">${data.cpu.brand}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Cores</span>
            <span class="stat-value">${data.cpu.cores} (${data.cpu.physicalCores} physical)</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Load</span>
            <span class="stat-value ${getLoadClass(data.cpu.load)}">${data.cpu.load.toFixed(1)}%</span>
          </div>
        `;
      }

      if (data.cpu.loadPerCore) {
        document.getElementById('cpu-cores').innerHTML = data.cpu.loadPerCore.map((load, i) => `
          <div class="core-item">
            <div class="label">Core ${i}</div>
            <div class="value ${getLoadClass(load)}">${load.toFixed(0)}%</div>
          </div>
        `).join('');
      }

      // Memory
      const memPercent = (data.memory.used / (isFull ? data.memory.total : (data.memory.used + data.memory.free))) * 100;
      memData.push(memPercent);
      if (memData.length > MAX_DATA_POINTS) memData.shift();
      memChart.update('none');
      document.getElementById('mem-bar').style.width = memPercent.toFixed(1) + '%';

      if (isFull) {
        document.getElementById('mem-info').innerHTML = `
          <div class="stat-row">
            <span class="stat-label">Used</span>
            <span class="stat-value">${formatBytes(data.memory.used)} / ${formatBytes(data.memory.total)}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Available</span>
            <span class="stat-value">${formatBytes(data.memory.available)}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Swap</span>
            <span class="stat-value">${formatBytes(data.memory.swapUsed)} / ${formatBytes(data.memory.swapTotal)}</span>
          </div>
        `;
      }

      // Network
      const netRx = data.network.reduce((sum, n) => sum + (n.rx_sec || 0), 0);
      const netTx = data.network.reduce((sum, n) => sum + (n.tx_sec || 0), 0);
      netRxData.push(netRx);
      netTxData.push(netTx);
      if (netRxData.length > MAX_DATA_POINTS) netRxData.shift();
      if (netTxData.length > MAX_DATA_POINTS) netTxData.shift();
      netChart.update('none');

      document.getElementById('net-info').innerHTML = `
        <div class="stat-row">
          <span class="stat-label">Download</span>
          <span class="stat-value">${formatBps(netRx)}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Upload</span>
          <span class="stat-value">${formatBps(netTx)}</span>
        </div>
      `;

      // Disk
      if (isFull && data.disk) {
        document.getElementById('disk-info').innerHTML = data.disk.map(d => `
          <div class="stat-row">
            <span class="stat-label">${d.mount}</span>
            <span class="stat-value ${getLoadClass(d.usePercent)}">${d.usePercent.toFixed(0)}%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill disk" style="width: ${d.usePercent}%"></div>
          </div>
          <div style="font-size: 11px; color: #888; margin-top: 4px; margin-bottom: 8px;">
            ${formatBytes(d.used)} / ${formatBytes(d.size)}
          </div>
        `).join('');
      }

      // Processes
      if (isFull && data.processes) {
        document.getElementById('process-tbody').innerHTML = data.processes.list.map(p => `
          <tr>
            <td>${p.pid}</td>
            <td>${p.name}</td>
            <td class="${getLoadClass(p.cpu)}">${p.cpu.toFixed(1)}%</td>
            <td>${p.mem.toFixed(1)}%</td>
            <td>${p.state}</td>
            <td>${p.user}</td>
          </tr>
        `).join('');
      }

      // System info
      if (isFull && data.system && data.os) {
        document.getElementById('system-info').textContent =
          `${data.os.hostname} | ${data.os.distro} ${data.os.release} | Up: ${Math.floor(data.os.uptime / 3600)}h`;
      }
    }

    // Connect to WebSocket
    const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
    const ws = new WebSocket(`${protocol}//${location.host}`);

    ws.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      updateUI(msg.data, msg.type === 'full');
    };

    ws.onerror = (err) => {
      console.error('WebSocket error:', err);
    };

    ws.onclose = () => {
      document.getElementById('system-info').textContent = 'Disconnected';
    };
  </script>
</body>
</html>
