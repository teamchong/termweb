"use strict";(()=>{var r=class{constructor(e="ws://localhost:7682"){this.ws=null;this.clientId=null;this.sessions=new Map;this.reconnectAttempts=0;this.maxReconnectAttempts=5;this.opfsRoot=null;this.url=e}async connect(){return new Promise((e,s)=>{try{this.ws=new WebSocket(this.url),this.ws.onopen=()=>{this.reconnectAttempts=0,this.initOPFS()},this.ws.onmessage=t=>{this.handleMessage(JSON.parse(t.data),e)},this.ws.onclose=()=>{this.onDisconnect?.(),this.tryReconnect()},this.ws.onerror=()=>{s(new Error("WebSocket connection failed"))}}catch(t){s(t)}})}async initOPFS(){try{"storage"in navigator&&"getDirectory"in navigator.storage&&(this.opfsRoot=await navigator.storage.getDirectory())}catch{}}handleMessage(e,s){switch(e.type){case"connected":this.clientId=e.clientId??null,this.onConnect?.(),s?.();break;case"data":if(e.sessionId!==void 0){let t=e.compressed?this.decompress(e.data):e.data;this.sessions.get(e.sessionId)?.onData?.(t),this.saveToOPFS(e.sessionId,t)}break;case"exit":e.sessionId!==void 0&&(this.sessions.get(e.sessionId)?.onExit?.(e.code??0),this.sessions.delete(e.sessionId));break;case"error":this.onError?.(e.error??"Unknown error");break;case"created":case"attached":case"killed":case"sessions":case"scrollback":break}}decompress(e){let s=atob(e),t=new Uint8Array(s.length);for(let n=0;n<s.length;n++)t[n]=s.charCodeAt(n);return typeof pako<"u"?pako.inflate(t,{to:"string"}):new TextDecoder().decode(t)}async saveToOPFS(e,s){if(this.opfsRoot)try{let t=`session_${e}_scrollback.txt`,n=await this.opfsRoot.getFileHandle(t,{create:!0}),o=await n.createWritable({keepExistingData:!0}),i=await n.getFile();await o.seek(i.size),await o.write(s),await o.close()}catch{}}async loadFromOPFS(e){if(!this.opfsRoot)return null;try{let s=`session_${e}_scrollback.txt`;return await(await(await this.opfsRoot.getFileHandle(s)).getFile()).text()}catch{return null}}async clearOPFS(e){if(this.opfsRoot)try{let s=`session_${e}_scrollback.txt`;await this.opfsRoot.removeEntry(s)}catch{}}tryReconnect(){this.reconnectAttempts<this.maxReconnectAttempts&&(this.reconnectAttempts++,setTimeout(()=>this.connect(),1e3*this.reconnectAttempts))}send(e){this.ws?.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify(e))}createSession(e,s={}){return new Promise(t=>{let n=o=>{let i=JSON.parse(o.data);i.type==="created"&&(this.sessions.set(i.sessionId,e),this.ws?.removeEventListener("message",n),t(i.sessionId))};this.ws?.addEventListener("message",n),this.send({type:"create",cols:s.cols??80,rows:s.rows??24,shell:s.shell})})}attachSession(e,s){return new Promise(t=>{let n=o=>{let i=JSON.parse(o.data);i.type==="attached"&&i.sessionId===e&&(this.sessions.set(e,s),this.ws?.removeEventListener("message",n),t())};this.ws?.addEventListener("message",n),this.send({type:"attach",sessionId:e})})}write(e,s){this.send({type:"input",sessionId:e,data:s})}resize(e,s,t){this.send({type:"resize",sessionId:e,cols:s,rows:t})}kill(e){this.send({type:"kill",sessionId:e}),this.sessions.delete(e)}listSessions(){return new Promise(e=>{let s=t=>{let n=JSON.parse(t.data);n.type==="sessions"&&(this.ws?.removeEventListener("message",s),e(n.sessions))};this.ws?.addEventListener("message",s),this.send({type:"list"})})}disconnect(){this.ws?.close(),this.ws=null,this.sessions.clear()}};typeof window<"u"&&(window.MuxClient=r);})();
