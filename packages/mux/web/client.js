var L={KEY_INPUT:1,MOUSE_INPUT:2,MOUSE_MOVE:3,MOUSE_SCROLL:4,TEXT_INPUT:5,RESIZE:16,REQUEST_KEYFRAME:17,PAUSE_STREAM:18,RESUME_STREAM:19,CONNECT_PANEL:32,CREATE_PANEL:33},W={KEYFRAME:1,DELTA:2},z={FILE_UPLOAD:16,FILE_DOWNLOAD:17,FOLDER_DOWNLOAD:20,CLOSE_PANEL:129,RESIZE_PANEL:130,FOCUS_PANEL:131,SPLIT_PANEL:132,CLOSE_TAB:133,SWITCH_TAB:134,NEW_TAB:135,RENAME_TAB:136,GET_AUTH_STATE:144,SET_PASSWORD:145,VERIFY_PASSWORD:146,CLEAR_PASSWORD:147,CREATE_SESSION:148,DELETE_SESSION:149,REGEN_TOKEN:150,CREATE_SHARE_LINK:151,REVOKE_SHARE_LINK:152,GET_SESSION_LIST:153,GET_SHARE_LINKS:154},A={FILE_DATA:18,FILE_ERROR:19,FOLDER_DATA:21},_={AUTH_STATE:10,SESSION_LIST:11,SHARE_LINKS:12},r={TRANSFER_INIT:32,FILE_LIST_REQUEST:33,FILE_DATA:34,TRANSFER_RESUME:35,TRANSFER_CANCEL:36,TRANSFER_READY:48,FILE_LIST:49,FILE_REQUEST:50,FILE_ACK:51,TRANSFER_COMPLETE:52,TRANSFER_ERROR:53,DRY_RUN_REPORT:54},d={ADMIN:0,EDITOR:1,VIEWER:2,NONE:255},P={KeyA:0,KeyS:1,KeyD:2,KeyF:3,KeyH:4,KeyG:5,KeyZ:6,KeyX:7,KeyC:8,KeyV:9,IntlBackslash:10,KeyB:11,KeyQ:12,KeyW:13,KeyE:14,KeyR:15,KeyY:16,KeyT:17,Digit1:18,Digit2:19,Digit3:20,Digit4:21,Digit6:22,Digit5:23,Equal:24,Digit9:25,Digit7:26,Minus:27,Digit8:28,Digit0:29,BracketRight:30,KeyO:31,KeyU:32,BracketLeft:33,KeyI:34,KeyP:35,Enter:36,KeyL:37,KeyJ:38,Quote:39,KeyK:40,Semicolon:41,Backslash:42,Comma:43,Slash:44,KeyN:45,KeyM:46,Period:47,Tab:48,Space:49,Backquote:50,Backspace:51,Escape:53,MetaRight:54,MetaLeft:55,ShiftLeft:56,CapsLock:57,AltLeft:58,ControlLeft:59,ShiftRight:60,AltRight:61,ControlRight:62,F17:64,NumpadDecimal:65,NumpadMultiply:67,NumpadAdd:69,NumLock:71,NumpadDivide:75,NumpadEnter:76,NumpadSubtract:78,F18:79,F19:80,NumpadEqual:81,Numpad0:82,Numpad1:83,Numpad2:84,Numpad3:85,Numpad4:86,Numpad5:87,Numpad6:88,Numpad7:89,F20:90,Numpad8:91,Numpad9:92,IntlYen:93,IntlRo:94,F5:96,F6:97,F7:98,F3:99,F8:100,F9:101,F11:103,F13:105,F16:106,F14:107,F10:109,F12:111,F15:113,Home:115,PageUp:116,Delete:117,F4:118,End:119,F2:120,PageDown:121,F1:122,ArrowLeft:123,ArrowRight:124,ArrowDown:125,ArrowUp:126};var F=`
  @group(0) @binding(0) var<storage, read> diff: array<u32>;
  @group(0) @binding(1) var<storage, read_write> prev: array<u32>;

  @compute @workgroup_size(256)
  fn main(@builtin(global_invocation_id) id: vec3<u32>) {
    let idx = id.x;
    if (idx < arrayLength(&prev)) {
      prev[idx] = prev[idx] ^ diff[idx];
    }
  }
`,H=`
  @group(0) @binding(0) var<storage, read> rgb: array<u32>;
  @group(0) @binding(1) var outTex: texture_storage_2d<rgba8unorm, write>;

  @compute @workgroup_size(16, 16)
  fn main(@builtin(global_invocation_id) id: vec3<u32>) {
    let dims = textureDimensions(outTex);
    if (id.x >= dims.x || id.y >= dims.y) { return; }

    let pixelIdx = id.y * dims.x + id.x;
    let byteIdx = pixelIdx * 3u;
    let wordIdx = byteIdx / 4u;
    let byteOff = byteIdx % 4u;

    let w0 = rgb[wordIdx];
    let w1 = rgb[wordIdx + 1u];

    var r: u32; var g: u32; var b: u32;
    if (byteOff == 0u) {
      r = (w0 >> 0u) & 0xFFu;
      g = (w0 >> 8u) & 0xFFu;
      b = (w0 >> 16u) & 0xFFu;
    } else if (byteOff == 1u) {
      r = (w0 >> 8u) & 0xFFu;
      g = (w0 >> 16u) & 0xFFu;
      b = (w0 >> 24u) & 0xFFu;
    } else if (byteOff == 2u) {
      r = (w0 >> 16u) & 0xFFu;
      g = (w0 >> 24u) & 0xFFu;
      b = (w1 >> 0u) & 0xFFu;
    } else {
      r = (w0 >> 24u) & 0xFFu;
      g = (w1 >> 0u) & 0xFFu;
      b = (w1 >> 8u) & 0xFFu;
    }

    let color = vec4<f32>(f32(r) / 255.0, f32(g) / 255.0, f32(b) / 255.0, 1.0);
    textureStore(outTex, vec2<i32>(i32(id.x), i32(id.y)), color);
  }
`,O=`
  @group(0) @binding(0) var tex: texture_2d<f32>;
  @group(0) @binding(1) var samp: sampler;

  struct VSOut {
    @builtin(position) pos: vec4<f32>,
    @location(0) uv: vec2<f32>,
  };

  @vertex
  fn vs(@builtin(vertex_index) idx: u32) -> VSOut {
    var pos = array<vec2<f32>, 4>(
      vec2(-1.0, 1.0), vec2(1.0, 1.0), vec2(-1.0, -1.0), vec2(1.0, -1.0)
    );
    var uv = array<vec2<f32>, 4>(
      vec2(0.0, 0.0), vec2(1.0, 0.0), vec2(0.0, 1.0), vec2(1.0, 1.0)
    );
    var out: VSOut;
    out.pos = vec4(pos[idx], 0.0, 1.0);
    out.uv = uv[idx];
    return out;
  }

  @fragment
  fn fs(in: VSOut) -> @location(0) vec4<f32> {
    return textureSample(tex, samp, in.uv);
  }
`;class N{id;serverId;container;canvas;element;ws=null;width=0;height=0;pwd=null;sequence=0;lastReportedWidth=0;lastReportedHeight=0;resizeTimeout=null;resizeObserver=null;callbacks;device=null;context=null;pipeline=null;xorPipeline=null;rgbToRgbaPipeline=null;prevBuffer=null;diffBuffer=null;texture=null;sampler=null;xorBindGroup=null;convertBindGroup=null;renderBindGroup=null;inspectorEl;inspectorVisible=!1;inspectorHeight=200;inspectorActiveTab="screen";inspectorState=null;constructor(n,i,l=null,s={}){this.id=n,this.serverId=l,this.container=i,this.callbacks=s,this.canvas=document.createElement("canvas"),this.canvas.className="panel-canvas",this.canvas.tabIndex=0,this.element=document.createElement("div"),this.element.className="panel",this.element.appendChild(this.canvas),this.inspectorEl=this.createInspectorElement(),this.element.appendChild(this.inspectorEl),i.appendChild(this.element),this.setupInputHandlers(),this.initGPU(),this.setupResizeObserver()}createInspectorElement(){let n=document.createElement("div");return n.className="panel-inspector",n.innerHTML=`
      <div class="inspector-resize"></div>
      <div class="inspector-content">
        <div class="inspector-left">
          <div class="inspector-left-header">
            <div class="inspector-tabs">
              <button class="inspector-tab active" data-tab="screen">Screen</button>
            </div>
          </div>
          <div class="inspector-main"></div>
        </div>
        <div class="inspector-right">
          <div class="inspector-right-header">
            <span class="inspector-right-title">Surface Info</span>
          </div>
          <div class="inspector-sidebar"></div>
        </div>
      </div>
    `,this.setupInspectorHandlers(n),n}setupInspectorHandlers(n){let i=n.querySelectorAll(".inspector-tab");i.forEach((s)=>{s.addEventListener("click",()=>{i.forEach((u)=>u.classList.remove("active")),s.classList.add("active"),this.inspectorActiveTab=s.dataset.tab||"screen",this.sendInspectorTab(this.inspectorActiveTab),this.renderInspectorView()})});let l=n.querySelector(".inspector-resize");if(l){let s=0,u=0,t=(c)=>{let D=s-c.clientY,f=Math.min(Math.max(u+D,100),this.element.clientHeight*0.6);this.inspectorHeight=f,this.inspectorEl.style.height=`${f}px`},m=()=>{document.removeEventListener("mousemove",t),document.removeEventListener("mouseup",m),this.triggerResize()};l.addEventListener("mousedown",(c)=>{s=c.clientY,u=this.inspectorHeight,document.addEventListener("mousemove",t),document.addEventListener("mouseup",m)})}}toggleInspector(){this.inspectorVisible?this.hideInspector():this.showInspector()}showInspector(){this.inspectorVisible=!0,this.inspectorEl.classList.add("visible"),this.inspectorEl.style.height=`${this.inspectorHeight}px`,this.sendInspectorSubscribe(),this.triggerResize()}hideInspector(){this.inspectorVisible=!1,this.inspectorEl.classList.remove("visible"),this.sendInspectorUnsubscribe(),this.triggerResize()}sendInspectorSubscribe(){this.ws?.send(JSON.stringify({type:"inspector_subscribe",tab:this.inspectorActiveTab}))}sendInspectorUnsubscribe(){this.ws?.send(JSON.stringify({type:"inspector_unsubscribe"}))}sendInspectorTab(n){this.ws?.send(JSON.stringify({type:"inspector_tab",tab:n}))}handleInspectorState(n){this.inspectorState=n,this.renderInspectorSidebar(),this.renderInspectorView()}renderInspectorSidebar(){let n=this.inspectorEl.querySelector(".inspector-sidebar");if(!n||!this.inspectorState)return;let l=this.inspectorState.size||{};n.innerHTML=`
      <div class="inspector-simple-section">
        <span class="inspector-simple-title">Dimensions</span>
        <hr>
      </div>
      <div class="inspector-row">
        <span class="inspector-label">Screen Size</span>
        <span class="inspector-value">${l.screen_width??0}px x ${l.screen_height??0}px</span>
      </div>
      <div class="inspector-row">
        <span class="inspector-label">Grid Size</span>
        <span class="inspector-value">${l.cols??0}c x ${l.rows??0}r</span>
      </div>
      <div class="inspector-row">
        <span class="inspector-label">Cell Size</span>
        <span class="inspector-value">${l.cell_width??0}px x ${l.cell_height??0}px</span>
      </div>
    `}renderInspectorView(){let n=this.inspectorEl.querySelector(".inspector-main");if(!n)return;let l=this.inspectorState?.size||{};n.innerHTML=`
      <div class="inspector-simple-section">
        <span class="inspector-simple-title">Terminal Size</span>
        <hr>
      </div>
      <div class="inspector-row">
        <span class="inspector-label">Grid</span>
        <span class="inspector-value">${l.cols??0} columns × ${l.rows??0} rows</span>
      </div>
      <div class="inspector-row">
        <span class="inspector-label">Screen</span>
        <span class="inspector-value">${l.screen_width??0} × ${l.screen_height??0} px</span>
      </div>
    `}triggerResize(){requestAnimationFrame(()=>{let n=this.canvas.getBoundingClientRect(),i=Math.floor(n.width),l=Math.floor(n.height);if(i>0&&l>0&&this.serverId!==null&&this.callbacks.onResize)this.lastReportedWidth=i,this.lastReportedHeight=l,this.callbacks.onResize(this.serverId,i,l)})}setupResizeObserver(){this.resizeObserver=new ResizeObserver(()=>{if(this.resizeTimeout)clearTimeout(this.resizeTimeout);this.resizeTimeout=setTimeout(()=>{let n=this.container.getBoundingClientRect(),i=Math.floor(n.width),l=Math.floor(n.height);if(i===0||l===0)return;if(i===this.lastReportedWidth&&l===this.lastReportedHeight)return;if(this.lastReportedWidth=i,this.lastReportedHeight=l,this.serverId!==null&&this.callbacks.onResize)this.callbacks.onResize(this.serverId,i,l)},16)}),this.resizeObserver.observe(this.element)}async initGPU(){if(!navigator.gpu){console.error("WebGPU not supported");return}let n=await navigator.gpu.requestAdapter();if(!n){console.error("No WebGPU adapter");return}if(this.device=await n.requestDevice(),this.context=this.canvas.getContext("webgpu"),!this.context){console.error("Could not get WebGPU context");return}let i=navigator.gpu.getPreferredCanvasFormat();this.context.configure({device:this.device,format:i,alphaMode:"opaque"});let l=this.device.createShaderModule({code:F});this.xorPipeline=this.device.createComputePipeline({layout:"auto",compute:{module:l,entryPoint:"main"}});let s=this.device.createShaderModule({code:H});this.rgbToRgbaPipeline=this.device.createComputePipeline({layout:"auto",compute:{module:s,entryPoint:"main"}});let u=this.device.createShaderModule({code:O});this.pipeline=this.device.createRenderPipeline({layout:"auto",vertex:{module:u,entryPoint:"vs"},fragment:{module:u,entryPoint:"fs",targets:[{format:i}]},primitive:{topology:"triangle-strip"}}),this.sampler=this.device.createSampler({magFilter:"nearest",minFilter:"nearest"}),console.log("WebGPU initialized")}createGPUBuffers(n,i){if(!this.device)return;this.prevBuffer?.destroy(),this.diffBuffer?.destroy(),this.texture?.destroy();let l=n*i*3,s=Math.ceil(l/4)*4;this.prevBuffer=this.device.createBuffer({size:s,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.diffBuffer=this.device.createBuffer({size:s,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.texture=this.device.createTexture({size:[n,i],format:"rgba8unorm",usage:GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING}),this.xorBindGroup=this.device.createBindGroup({layout:this.xorPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.diffBuffer}},{binding:1,resource:{buffer:this.prevBuffer}}]}),this.convertBindGroup=this.device.createBindGroup({layout:this.rgbToRgbaPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.prevBuffer}},{binding:1,resource:this.texture.createView()}]}),this.renderBindGroup=this.device.createBindGroup({layout:this.pipeline.getBindGroupLayout(0),entries:[{binding:0,resource:this.texture.createView()},{binding:1,resource:this.sampler}]})}connect(n,i){this.ws=new WebSocket(`ws://${n}:${i}`),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{if(console.log(`Panel ${this.id}: Connected`),this.serverId!==null)this.sendConnectPanel(this.serverId);else this.sendCreatePanel()},this.ws.onmessage=(l)=>{if(typeof l.data==="string")try{let s=JSON.parse(l.data);if(s.type==="inspector_state")this.handleInspectorState(s)}catch(s){console.error("Failed to parse JSON:",s)}else this.handleFrame(l.data)},this.ws.onclose=()=>{console.log(`Panel ${this.id}: Disconnected`)},this.ws.onerror=()=>{if(this.ws?.readyState===WebSocket.CLOSING||this.ws?.readyState===WebSocket.CLOSED)return;console.error(`Panel ${this.id}: WebSocket error`)}}disconnect(){this.ws?.close(),this.ws=null}sendConnectPanel(n){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return;let i=new ArrayBuffer(5),l=new DataView(i);l.setUint8(0,L.CONNECT_PANEL),l.setUint32(1,n,!0),this.ws.send(i)}sendCreatePanel(){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return;let n=this.container.getBoundingClientRect(),i=Math.floor(n.width)||800,l=Math.floor(n.height)||600,s=window.devicePixelRatio||1;this.lastReportedWidth=i,this.lastReportedHeight=l;let u=new ArrayBuffer(9),t=new DataView(u);t.setUint8(0,L.CREATE_PANEL),t.setUint16(1,i,!0),t.setUint16(3,l,!0),t.setFloat32(5,s,!0),this.ws.send(u)}async handleFrame(n){if(!this.device)return;let i=new DataView(n),l=i.getUint8(0),s=i.getUint32(1,!0),u=i.getUint16(5,!0),t=i.getUint16(7,!0),m=i.getUint32(9,!0);if(l===255){this.serverId=i.getUint32(1,!0),console.log(`Panel ${this.id} assigned server ID: ${this.serverId}`);return}if(u!==this.width||t!==this.height){this.width=u,this.height=t,this.canvas.width=u,this.canvas.height=t;let E=navigator.gpu.getPreferredCanvasFormat();this.context.configure({device:this.device,format:E,alphaMode:"opaque"}),this.createGPUBuffers(u,t)}let c=new Uint8Array(n,13,m),D;try{D=await this.decompress(c)}catch(E){console.error("Decompress failed:",E);return}let f=u*t*3;if(D.length!==f){console.error(`Size mismatch: got ${D.length}, expected ${f}`);return}let X=Math.ceil(D.length/4)*4,j=D;if(D.length!==X)j=new Uint8Array(X),j.set(D);if(l===W.KEYFRAME)this.device.queue.writeBuffer(this.prevBuffer,0,j);else{this.device.queue.writeBuffer(this.diffBuffer,0,j);let E=this.device.createCommandEncoder(),J=E.beginComputePass();J.setPipeline(this.xorPipeline),J.setBindGroup(0,this.xorBindGroup),J.dispatchWorkgroups(Math.ceil(D.length/4/256)),J.end(),this.device.queue.submit([E.finish()])}this.renderFrame(),this.sequence=s}async decompress(n){let i=new DecompressionStream("deflate-raw"),l=i.writable.getWriter();l.write(n),l.close();let s=i.readable.getReader(),u=[],t=0;while(!0){let{done:D,value:f}=await s.read();if(D)break;u.push(f),t+=f.length}let m=new Uint8Array(t),c=0;for(let D of u)m.set(D,c),c+=D.length;return m}renderFrame(){if(!this.device||!this.context||!this.pipeline)return;let n=this.device.createCommandEncoder(),i=n.beginComputePass();i.setPipeline(this.rgbToRgbaPipeline),i.setBindGroup(0,this.convertBindGroup),i.dispatchWorkgroups(Math.ceil(this.width/16),Math.ceil(this.height/16)),i.end();let l=n.beginRenderPass({colorAttachments:[{view:this.context.getCurrentTexture().createView(),loadOp:"clear",storeOp:"store",clearValue:{r:0,g:0,b:0,a:1}}]});l.setPipeline(this.pipeline),l.setBindGroup(0,this.renderBindGroup),l.draw(4),l.end(),this.device.queue.submit([n.finish()])}setupInputHandlers(){this.canvas.addEventListener("keydown",(n)=>{n.preventDefault();let i=P[n.code]??0,l=this.getModifiers(n);this.sendKeyInput(i,1,l,n.key.length===1?n.key:void 0)}),this.canvas.addEventListener("keyup",(n)=>{n.preventDefault();let i=P[n.code]??0,l=this.getModifiers(n);this.sendKeyInput(i,0,l)}),this.canvas.addEventListener("mousedown",(n)=>{this.canvas.focus();let i=this.canvas.getBoundingClientRect();this.sendMouseInput(n.clientX-i.left,n.clientY-i.top,n.button,1,this.getModifiers(n))}),this.canvas.addEventListener("mouseup",(n)=>{let i=this.canvas.getBoundingClientRect();this.sendMouseInput(n.clientX-i.left,n.clientY-i.top,n.button,0,this.getModifiers(n))}),this.canvas.addEventListener("mousemove",(n)=>{if(n.buttons===0)return;let i=this.canvas.getBoundingClientRect(),l=new ArrayBuffer(8),s=new DataView(l);s.setUint8(0,L.MOUSE_MOVE),s.setUint16(1,n.clientX-i.left,!0),s.setUint16(3,n.clientY-i.top,!0),s.setUint8(5,n.buttons),s.setUint8(6,this.getModifiers(n)),this.ws?.send(l)}),this.canvas.addEventListener("wheel",(n)=>{n.preventDefault();let i=new ArrayBuffer(6),l=new DataView(i);l.setUint8(0,L.MOUSE_SCROLL),l.setInt16(1,Math.round(n.deltaX),!0),l.setInt16(3,Math.round(n.deltaY),!0),l.setUint8(5,this.getModifiers(n)),this.ws?.send(i)}),this.canvas.addEventListener("contextmenu",(n)=>n.preventDefault())}getModifiers(n){let i=0;if(n.shiftKey)i|=1;if(n.ctrlKey)i|=2;if(n.altKey)i|=4;if(n.metaKey)i|=8;return i}sendKeyInput(n,i,l,s){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return;let u=s?new TextEncoder().encode(s):new Uint8Array(0),t=new ArrayBuffer(8+u.length),m=new DataView(t);m.setUint8(0,L.KEY_INPUT),m.setUint32(1,n,!0),m.setUint8(5,i),m.setUint8(6,l),m.setUint8(7,u.length),new Uint8Array(t).set(u,8),this.ws.send(t)}sendMouseInput(n,i,l,s,u){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return;let t=new ArrayBuffer(8),m=new DataView(t);m.setUint8(0,L.MOUSE_INPUT),m.setUint16(1,Math.round(n),!0),m.setUint16(3,Math.round(i),!0),m.setUint8(5,l),m.setUint8(6,s),m.setUint8(7,u),this.ws.send(t)}sendTextInput(n){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return;let i=new TextEncoder().encode(n),l=new ArrayBuffer(3+i.length),s=new DataView(l);s.setUint8(0,L.TEXT_INPUT),s.setUint16(1,i.length,!0),new Uint8Array(l).set(i,3),this.ws.send(l)}requestKeyframe(){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return;let n=new ArrayBuffer(1);new DataView(n).setUint8(0,L.REQUEST_KEYFRAME),this.ws.send(n)}focus(){this.canvas.focus()}reparent(n){this.container=n,n.appendChild(this.element),setTimeout(()=>{let i=this.container.getBoundingClientRect(),l=Math.floor(i.width),s=Math.floor(i.height);if(l>0&&s>0&&(l!==this.lastReportedWidth||s!==this.lastReportedHeight)){if(this.lastReportedWidth=l,this.lastReportedHeight=s,this.serverId!==null&&this.callbacks.onResize)this.callbacks.onResize(this.serverId,l,s)}},0)}destroy(){this.disconnect(),this.resizeObserver?.disconnect(),this.prevBuffer?.destroy(),this.diffBuffer?.destroy(),this.texture?.destroy(),this.element.remove()}}function Z(n){let i=n.match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);return i?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16)}:null}function Q(n,i,l){return`#${Math.round(n).toString(16).padStart(2,"0")}${Math.round(i).toString(16).padStart(2,"0")}${Math.round(l).toString(16).padStart(2,"0")}`}function Y(n){let i=Z(n);if(!i)return 0;return 0.299*i.r/255+0.587*i.g/255+0.114*i.b/255}function B(n){return Y(n)>0.5}function T(n){return Y(n)<0.05}function o(n,i){let l=Z(n);if(!l)return n;let s=l.r+(255-l.r)*i,u=l.g+(255-l.g)*i,t=l.b+(255-l.b)*i;return Q(s,u,t)}function R(n,i){let l=Z(n);if(!l)return n;let s=l.r*(1-i),u=l.g*(1-i),t=l.b*(1-i);return Q(s,u,t)}function I(n,i){let l=Z(n);if(!l)return n;let s=l.r*(1-i),u=l.g*(1-i),t=l.b*(1-i);return Q(s,u,t)}function y(n){if(n<1024)return`${n} B`;if(n<1048576)return`${(n/1024).toFixed(1)} KB`;if(n<1073741824)return`${(n/1048576).toFixed(1)} MB`;return`${(n/1073741824).toFixed(2)} GB`}function V(){return Math.random().toString(36).substring(2,9)}function x(n,i){let l=null;return(...s)=>{if(l)clearTimeout(l);l=setTimeout(()=>n(...s),i)}}function v(n,i){let l=!1;return(...s)=>{if(!l)n(...s),l=!0,setTimeout(()=>l=!1,i)}}function q(n){let i=document.documentElement,l=n.background||"#282c34",s=n.foreground||"#ffffff",u=B(l);i.style.setProperty("--bg",l),i.style.setProperty("--toolbar-bg",l);let t=R(l,0.1);i.style.setProperty("--tabbar-bg",t),i.style.setProperty("--tab-active",l),i.style.setProperty("--text",s);let m=u?"0,0,0":"255,255,255";i.style.setProperty("--tab-hover",`rgba(${m},0.08)`),i.style.setProperty("--close-hover",`rgba(${m},0.1)`),i.style.setProperty("--text-dim",`rgba(${m},0.5)`),i.style.setProperty("--accent",s);for(let c=0;c<16;c++){let D=`palette${c}`;if(n[D])i.style.setProperty(`--palette-${c}`,n[D])}}function w(){let n={},i=window.location.search.substring(1);if(!i)return n;for(let l of i.split("&")){let[s,u]=l.split("=");if(s)n[decodeURIComponent(s)]=decodeURIComponent(u||"")}return n}function a(n,...i){let l=1;for(let c of i)l+=typeof c==="number"?1:c.length;let s=new ArrayBuffer(l),u=new DataView(s),t=new Uint8Array(s),m=0;u.setUint8(m++,n);for(let c of i)if(typeof c==="number")u.setUint8(m++,c);else t.set(c,m),m+=c.length;return s}function b(n,i){return n.getUint16(i,!0)}function g(n,i){return n.getUint32(i,!0)}function e(n,i,l){n.setUint16(i,l,!0)}function nn(n,i,l){n.setUint32(i,l,!0)}class ${parent;direction=null;first=null;second=null;panel=null;ratio=0.5;element;divider=null;isDragging=!1;constructor(n=null){this.parent=n,this.element=document.createElement("div")}static createLeaf(n,i=null){let l=new $(i);return l.panel=n,l.element=document.createElement("div"),l.element.className="split-pane",l.element.style.flex="1",n.reparent(l.element),l}split(n,i){if(this.direction!==null)return console.error("Cannot split a non-leaf container directly"),null;let l=n==="left"||n==="right",s=n==="left"||n==="up",u=this.panel;if(this.panel=null,this.direction=l?"horizontal":"vertical",s)this.first=$.createLeaf(i,this),this.second=$.createLeaf(u,this);else this.first=$.createLeaf(u,this),this.second=$.createLeaf(i,this);return this.rebuildDOM(),s?this.first:this.second}rebuildDOM(){let n=this.element.parentElement,i=this.element;if(this.element=document.createElement("div"),this.element.className=`split-container ${this.direction}`,this.element.appendChild(this.first.element),this.divider=document.createElement("div"),this.divider.className="split-divider",this.setupDividerDrag(),this.element.appendChild(this.divider),this.element.appendChild(this.second.element),this.applyRatio(),n)n.replaceChild(this.element,i)}setupDividerDrag(){let n=0,i=0,l=0,s=(m)=>{m.preventDefault(),this.isDragging=!0,this.divider.classList.add("dragging");let c=this.element.getBoundingClientRect();if(this.direction==="horizontal")n=m.clientX,l=c.width;else n=m.clientY,l=c.height;i=this.ratio,document.addEventListener("mousemove",u),document.addEventListener("mouseup",t)},u=(m)=>{if(!this.isDragging)return;let c;if(this.direction==="horizontal")c=m.clientX-n;else c=m.clientY-n;let f=l-4,X=c/f;this.ratio=Math.max(0.1,Math.min(0.9,i+X)),this.applyRatio()},t=()=>{this.isDragging=!1,this.divider.classList.remove("dragging"),document.removeEventListener("mousemove",u),document.removeEventListener("mouseup",t)};this.divider.addEventListener("mousedown",s)}applyRatio(){if(!this.first||!this.second)return;let n=(this.ratio*100).toFixed(2),i=((1-this.ratio)*100).toFixed(2);this.first.element.style.flex=`0 0 calc(${n}% - 2px)`,this.second.element.style.flex=`0 0 calc(${i}% - 2px)`}findContainer(n){if(this.panel===n)return this;if(this.first){let i=this.first.findContainer(n);if(i)return i}if(this.second){let i=this.second.findContainer(n);if(i)return i}return null}getAllPanels(){let n=[];if(this.panel)n.push(this.panel);if(this.first)n.push(...this.first.getAllPanels());if(this.second)n.push(...this.second.getAllPanels());return n}removePanel(n){if(this.panel===n)return!0;if(this.first&&this.first.panel===n){let i=this.first;if(this.promoteChild(this.second),i.element)i.element.remove();return!0}if(this.second&&this.second.panel===n){let i=this.second;if(this.promoteChild(this.first),i.element)i.element.remove();return!0}if(this.first&&this.first.removePanel(n))return!0;if(this.second&&this.second.removePanel(n))return!0;return!1}promoteChild(n){if(this.divider)this.divider.remove(),this.divider=null;if(n.direction!==null){if(this.direction=n.direction,this.first=n.first,this.second=n.second,this.ratio=n.ratio,this.divider=n.divider,this.panel=null,this.first)this.first.parent=this;if(this.second)this.second.parent=this;this.rebuildDOM()}else{this.direction=null,this.first=null,this.second=null,this.panel=n.panel;let i=this.element.parentElement,l=this.element;if(this.element=document.createElement("div"),this.element.className="split-pane",this.element.style.flex="1",this.panel.reparent(this.element),i)i.replaceChild(this.element,l)}}destroy(){if(this.panel)this.panel.destroy();if(this.first)this.first.destroy();if(this.second)this.second.destroy();if(this.element&&this.element.parentElement)this.element.remove()}}var C=0,K=0,M=0;class S{controlWs=null;fileWs=null;panels=new Map;tabs=new Map;activePanel=null;activeTab=null;host;constructor(){this.host=window.location.hostname||"localhost"}async init(){let n=await this.fetchConfig();if(C=n.panelWsPort,K=n.controlWsPort,M=n.fileWsPort,n.colors)q(n.colors);this.connectControl(),this.connectFileTransfer(),this.createTab(),this.setupShortcuts()}async fetchConfig(){return(await fetch("/config")).json()}connectControl(){let n=`ws://${this.host}:${K}`;this.controlWs=new WebSocket(n),this.controlWs.binaryType="arraybuffer",this.controlWs.onopen=()=>{console.log("Control channel connected")},this.controlWs.onmessage=(i)=>{this.handleControlMessage(i)},this.controlWs.onclose=()=>{console.log("Control channel disconnected"),setTimeout(()=>this.connectControl(),1000)}}connectFileTransfer(){let n=`ws://${this.host}:${M}`;this.fileWs=new WebSocket(n),this.fileWs.binaryType="arraybuffer",this.fileWs.onopen=()=>{console.log("File transfer channel connected")}}handleControlMessage(n){if(typeof n.data==="string"){let i=JSON.parse(n.data);this.handleJsonMessage(i)}else if(n.data instanceof ArrayBuffer)this.handleBinaryMessage(n.data)}handleJsonMessage(n){}handleBinaryMessage(n){}createTab(n="Terminal"){let i=V(),l=document.createElement("div");l.className="tab-content",l.id=`tab-${i}`,document.querySelector(".tabs-container")?.appendChild(l);let s=this.createPanel(l);return this.tabs.set(i,{id:i,title:n,root:null,element:l}),this.switchTab(i),i}createPanel(n){let i=V(),l=new N(i,n,null,{onResize:(s,u,t)=>this.handlePanelResize(s,u,t),onViewAction:(s,u)=>this.handleViewAction(l,s,u)});if(this.panels.set(i,l),l.connect(this.host,C),!this.activePanel)this.activePanel=l;return l}handlePanelResize(n,i,l){if(this.controlWs?.readyState===WebSocket.OPEN){let s=new ArrayBuffer(13),u=new DataView(s);u.setUint8(0,130),u.setUint32(1,n,!0),u.setUint32(5,i,!0),u.setUint32(9,l,!0),this.controlWs.send(s)}}handleViewAction(n,i,l){console.log("View action:",i,l)}switchTab(n){if(this.activeTab)this.tabs.get(this.activeTab)?.element.classList.remove("active");let i=this.tabs.get(n);if(i)i.element.classList.add("active"),this.activeTab=n}setupShortcuts(){document.addEventListener("keydown",(n)=>{if(n.metaKey&&n.key==="t")n.preventDefault(),this.createTab();if(n.metaKey&&n.key==="w"){if(n.preventDefault(),this.activeTab)this.closeTab(this.activeTab)}if(n.metaKey&&n.key>="1"&&n.key<="9"){n.preventDefault();let i=parseInt(n.key)-1,l=Array.from(this.tabs.keys());if(i<l.length)this.switchTab(l[i])}})}closeTab(n){let i=this.tabs.get(n);if(!i||this.tabs.size<=1)return;if(i.element.remove(),this.tabs.delete(n),this.activeTab===n){let l=Array.from(this.tabs.keys());if(l.length>0)this.switchTab(l[0])}}requestDownload(n,i=!1){if(!this.activePanel?.serverId){console.error("No active panel for download");return}if(n.endsWith("/"))i=!0,n=n.slice(0,-1);let l=this.activePanel.serverId,s=new TextEncoder().encode(n),u=7+s.length,t=new ArrayBuffer(u),m=new DataView(t),c=new Uint8Array(t),D=0;m.setUint8(D,i?20:17),D+=1,m.setUint32(D,l,!0),D+=4,m.setUint16(D,s.length,!0),D+=2,c.set(s,D),this.controlWs?.send(t),console.log(`Requesting ${i?"folder":"file"} download: ${n}`)}}var G;function U(){G=new S,G.init().catch(console.error),window.termwebApp=G}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",U);else U();export{nn as writeU32LE,e as writeU16LE,v as throttle,R as shadowColor,Q as rgbToHex,g as readU32LE,b as readU16LE,w as parseQueryParams,Y as luminance,T as isVeryDark,B as isLightColor,o as highlightColor,Z as hexToRgb,V as generateId,y as formatBytes,x as debounce,a as createBinaryMessage,I as blendWithBlack,q as applyColors,r as TransferMsgType,$ as SplitContainer,d as Role,N as Panel,P as KEY_MAP,W as FrameType,A as FileResponseType,L as ClientMsg,z as BinaryCtrlMsg,_ as AuthResponseType};
